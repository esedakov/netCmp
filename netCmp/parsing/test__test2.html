<html>
	<head>
		<link rel="stylesheet" type="text/css" href="../external/joint.css">
		<!--<script src="../external/jquery.min.js"></script>-->
		<script src="../external/jquery-1.11.3.min.js"></script>
		<script src="../external/lodash.min.js"></script>
		<script src="../external/backbone-min.js"></script>
		<script src="../external/joint.js"></script>
	</head>
	<body>
		<!-- according to example on http://www.jointjs.com/tutorial, create
			global container for joint to draw elements inside -->
		<div id="myholder"></div>
		<!-- remaining code goes in JS -->
		<script type="text/javascript">
			Object.prototype.areEqual = function(a,b){
				return a + b;
			}
			var glWidth = 1600, glHeight = 1600;
			var graph = new joint.dia.Graph;

			var paper = new joint.dia.Paper({
				el: $('#myholder'),
				width: glWidth,
				height: glHeight,
				model: graph,
				gridSize: 1,
				interactive: function(cellView, methodName){
					if( cellView.model.attr('isInteractive') === false ){
						return false;
					}
					return true;
				}
			});

			paper.on('cell:mouseover', 
				function(cellView, evt, x, y) { 
					alert('cell view ' + cellView.model.id + ' was clicked'); 
				}
			);

			var x = 50, y = 50;

			/*
			graph.addCells([
				createTextNode(x + 10, y + 10, '<div style="color:red;">MOV</div>', 'ff0000'),
				//createTextNode(x + )
			]);*/

//see: http://stackoverflow.com/questions/29556728/2-different-font-sizes-for-text-inside-basic-rect-jointjs
joint.shapes.command = joint.shapes.basic.Generic.extend({

    markup: '<g class="rotatable">' + 
    			'<g class="scalable">' +
    				'<rect/>' + 
    			'</g>' + 
    			'<text class="o_CmdId">' +
    				'<tspan class="i_CmdId"></tspan>' +
    			'</text>' +
    			'<text class="o_CmdTy">' +
    				'<tspan class="i_CmdTy"></tspan>' +
    			'</text>' +
    			'<text class="o_Arg1">' +
    				'<tspan class="i_Arg1"></tspan>' +
    			'</text>' +
    			'<text class="o_Arg2">' +
    				'<tspan class="i_Arg2"></tspan>' +
    			'</text>' +
    		'</g>',

    defaults: joint.util.deepSupplement({

        type: 'command',
        attrs: {
            rect: { 'follow-scale': true, width: 100, height: 100, fill: 'none' },
            '.i_CmdId': { 'font-size': 23, fill: '#ff7700', 'stroke': '#ff7700' },
            '.i_CmdTy': { 'font-size': 23, 'font-weight': 'bold', fill: '#000000', 'stroke': '#000000' },
            '.i_Arg1': { 'font-size': 23, fill: '#00ff00', 'stroke': '#00ff00' },
            '.i_Arg2': { 'font-size': 23, fill: '#00ff00', 'stroke': '#00ff00' }
        },
        size: { width: 160, height: 35 }
    }, joint.shapes.basic.Generic.prototype.defaults)
});


joint.shapes.block = joint.shapes.basic.Generic.extend({

    markup: '<g class="rotatable">' + 
    			'<g class="scalable">' +
    				'<rect/>' + 
    			'</g>' + 
    			'<text class="o_BlkName">' +
    				'<tspan class="i_BlkName"></tspan>' +
    			'</text>' +
    			'<rect class="minBtn"></rect>' +
    			'<path class="blkSep"></path>' +
    		'</g>',

    defaults: joint.util.deepSupplement({

        type: 'block',
        attrs: {
            rect: { 'follow-scale': true, width: 300, height: 300, fill: '#440044', opacity: 0.5, rx: 15, ry: 15 },
            '.i_BlkName': { 'font-size': 23, 'stroke': '#ffffff' },
            '.minBtn': { width: '15', height: '7', fill: 'red', stroke: 'green', 'stroke-width': 2, rx: 0, ry: 0 },
            '.blkSep': { 'stroke': '#ff00aa', 'stroke-width': 2, d:'M 0 40 L 300 40' },
        }
    }, joint.shapes.basic.Generic.prototype.defaults)
});

var b1 = createBlock(x, y, "1: block");
var c1 = createCommand(x+20, y+50, 13, "ADD", "$3", "$1");
b1.embed(c1);

var b2 = createBlock(x+400, x+50, "2: block");
var c2 = createCommand(x+420, x+100, 13, "SUB", "$21", "$4");
b2.embed(c2);
graph.addCells([b1,b2,c1,c2]);

var l = new joint.dia.Link({
	source: { id: b1.id },
	target: { id: b2.id }
});
l.attr({
	'.connection': {stroke: '#222222', 'stroke-width': 3},
	'.marker-target': {fill: '#222222', d: 'M 10 0 L 0 5 L 10 10 z'}
})
graph.addCells([l]);

//view_1();

function measureTextDim(text, fontsize){
	var lines = text.split('\n');
	return {
		height: (lines.length - 1) * (fontsize - 1),
		//see http://stackoverflow.com/questions/17386774/javascript-find-longest-word-in-a-string
		width: _.max(lines, function(word) { return word.length; }).length * (fontsize - 3)
	};
}

function createBlock(posX, posY, blkName){
	var rect = new joint.shapes.block({
		position: {
			x: posX,
			y: posY
		},
		size: {
			width: 700, height: 700
		},
		attrs: { 
			'.i_BlkName': {
				text: blkName
			},
			'.o_BlkName': {
				transform: "translate(15,10)"
			},
			'.minBtn': {
				transform: "translate(265,15)"
			}
		}
	});
	//graph.addCells([rect]);
	return rect;
}

function createCommand(posX, posY, cmdId, cmdTypeName, arg1Name, arg2Name){
	var cmdTy_left = measureTextDim(cmdId.toString(), 23).width;
	var arg1_left = cmdTy_left + measureTextDim(cmdTypeName.toString(), 23).width;
	var arg2_left = arg1_left + measureTextDim(arg1Name.toString(), 23).width;
	var rectShape = new joint.shapes.command({
		position: {
			x: posX,
			y: posY
		},
		attrs: {
			isInteractive: false,
			'.o_CmdId' : {
				transform: "translate(0,0)"
			},
			'.i_CmdId' : {
				text: cmdId + ' :'
			},
			'.o_CmdTy' : {
				transform: "translate(" + cmdTy_left + ",0)"
			},
			'.i_CmdTy' : {
				text: cmdTypeName
			},
			'.o_Arg1' : {
				transform: "translate(" + arg1_left + ",0)"
			},
			'.i_Arg1' : {
				text: arg1Name + ","
			},
			'.o_Arg2' : {
				transform: "translate(" + arg2_left + ",0)"
			},
			'.i_Arg2' : {
				text: arg2Name
			}
		}
	});
	//graph.addCells([rectShape]);
	return rectShape;
}
//rectShape.attr('.ts1/text', 'N');
//rectShape.attr('.ts2/text', '123');

			function createTextNode(x, y, t, c){
				return new joint.shapes.basic.Text({
					position: {
						x: x, y: y
					},
					size: {
						width: 'auto', height: 'auto'
					},
					attrs: {
						text: {
							text: t,
							stroke: "#" + c
						}
					}
				});
			};

			function view_2(){
				var rect = new joint.shapes.basic.Rect({
					position: {
						x: 100, y:100
					},
					size: {
						width: 200, height: 150
					},
					attrs: { 
						path: {
							d: "M 0 10 L 100 10", stroke: "rgba(255,0,0,1)"
						},
						rect: {
							opacity: 0.75, fill: 'lightblue'
						},
						text: {
							text: 'header', fill: 'white'
						}
					},
					events: {
						'mouseover':'mouseovercard'
					},
					mouseovercard: function(evt, x, y){
						alert("over at x: " + x + ", y: " + y);
					}
				});
				graph.addCells([rect]);
			}

			function view_1(){
				var tx = 100, ty = 100;
				var rect1 = drawRect({
					pos: {x: tx, y: ty},
					rectview: {rx: 15, ry: 15}
				}, graph);
				var rect2 = drawRect({
					pos: {x: tx+20, y: ty+20},
					dim: {width: 100, height: 30},
					rectview: {opacity: 0.75, fill: 'blue'},
					textview: {text: 'my box', fill: 'white'}
				}, graph);
				rect1.embed(rect2);
			};

			function drawRect(styles, g){
				//check if position is not defined in attributes
				if( !("pos" in styles) ){
					//define position
					styles.pos = {};
				}
				//if 'x' is not defined inside position
				if( !('x' in styles.pos) ){
					//generate x-position randomly
					styles.pos.x = Math.random() * glWidth;
				}
				//if 'x' is not defined inside position
				if( !('y' in styles.pos) ){
					//generate y-position randomly
					styles.pos.x = Math.random() * glWidth;
				}
				//check if dimensions is not defined in attributes
				if( !("dim" in styles) ){
					//define dimensions
					styles.dim = {};
				}
				//if 'height' is not defined inside dimensions
				if( !('height' in styles.dim) ){
					//assign default height
					styles.dim.height = 100;
				}
				//if 'x' is not defined inside dimensions
				if( !('width' in styles.dim) ){
					//assign default width
					styles.dim.width = 150;
				}
				//check if rect view is not defined in attributes
				if( !("rectview" in styles) ){
					//define rectangle view
					styles.rectview = {};
				}
				//if 'fill' (background color) is not defined in view
				if( !('fill' in styles.rectview) ){
					//assign default background color
					styles.rectview.fill = "#aa0023";
				}
				//if text view is not defined in attributes
				if( !("textview" in styles) ){
					//define text struct
					styles.textview = {};
				}
				//if 'text' is not defined in textual view
				if( !('text' in styles.textview) ){
					//assign default text inside rectangle
					styles.textview.text = "unknown label";
				}
				//if font color ('fill') is not defined in textual view
				if( !('fill' in styles.textview) ){
					//assign text font color
					styles.textview.fill = "#eeeeee";
				}
				//if font size is not defined in textual view
				if( !('font-size' in styles.textview) ){
					//assign default font size
					styles.textview['font-size'] = 18;
				}
				//create rect
				var rect = new joint.shapes.basic.Rect({
					position: styles.pos,
					size: styles.dim,
					attrs: { 
						rect: styles.rectview, 
						text: styles.textview 
					}
				});
				//add rect to graph
				g.addCells([rect]);
				return rect;
			}

		</script>
	</body>
</html>